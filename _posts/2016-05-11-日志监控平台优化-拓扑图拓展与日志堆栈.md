> 上次的版本我们方案是单机安装agent,execCommand的方式进行读取日志,存在日志丢失的隐患.也没有涉及离线相关的内容. 
> 实际是留了口子进行拓展的,我们来一发新的设计与优化. 

![](http://7xqjx7.com1.z0.glb.clouddn.com/image/Screen%20Shot%202016-05-11%20at%2010.53.50.png?imageView2/2/h/400) 

下面是新增的点介绍:

## 离线部分 

我们将消息消费两次,离线处理后落入HDFS或者直接从消息中间件落入HDFS都是可行的.目前组内没有这部分的开发计划,先留着这部分. 

## 日志堆栈 

上次的版本我们的agent来自flume而不是logstash,对多行日志的支持并不是很好,我们采用下面的方式进行修复. 

## flume的可用性 

我们舍弃之前的执行命令行读取的方式,在agent所在机器启用avro RPC服务接收日志,同时将log直接输入我们重写的flume的log4jAppender,把日志丢失的隐患排除掉一点. 

## flume collector的增加 

后续可以增加主备collector的部分,把agent链路放长一点,主备切换保持可用性,FileChannel部分可以落在collector中. 

## flume channel的切换 

看了来自美团的channel优化,新开发了DualChannel设置阈值来使用内存还是memory,我们把这个作为可优化的点,因为目前业务量不是很大,我们偶遇了agent集群的话,这部分的运维也不是很困难.  









