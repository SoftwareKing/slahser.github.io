上次我们搭建了一套 demo 环境,那么这次算是后日谈,解决一些新生的与遗留的问题. 

> 果然什么技术栈落地都不是能光速完成的,基础设施初见杀远比写代码麻烦的多. 

本期内容: 

- 技术名词实战版
- heapster 资源可视化


## 技术名词 

运行` kubectl get --help `可以看到一大串抽象与定义,如下: 

我将初见可以理解的部分中文写在了后面,其他的比如磁盘挂载, nginx ingress 等到更多探索再写出. 

```
* clusters (valid only for federation apiservers) - 集群
* componentstatuses (aka 'cs') 
* configmaps (aka 'cm')
* daemonsets (aka 'ds')
* deployments (aka 'deploy') - 定义了固定数目的 pod 与 service 用于基础组件搭建
* events (aka 'ev') 
* endpoints (aka 'ep') - ip:port 组成的端点
* horizontalpodautoscalers (aka 'hpa')
* ingress (aka 'ing') - 将 NodePort 暴露的负载均衡口子
* jobs
* limitranges (aka 'limits')
* nodes (aka 'no') - 实体机器
* namespaces (aka 'ns') - 命名空间,用来隔离. 默认 default, 组件在 kube-system 中
* petsets (alpha feature, may be unstable)
* pods (aka 'po') - 抽象
* persistentvolumes (aka 'pv')
* persistentvolumeclaims (aka 'pvc')
* quota
* resourcequotas (aka 'quota')
* replicasets (aka 'rs')
* replicationcontrollers (aka 'rc') - 控制 pod 生命周期的组件
* secrets
* serviceaccounts (aka 'sa')
* services (aka 'svc') - pod 的聚合
``` 

## 资源占用可视化 

![](https://o4dyfn0ef.qnssl.com/image/2016-11-15-Screen%20Shot%202016-11-15%20at%2016.40.42.png?imageView2/2/h/400) 

```shell
git clone https://github.com/kubernetes/heapster.git
cd heapster
# 不要偷懒只在 master 上提前 pull 镜像,因为 pod 可能被 scheduler 分配到其他 node 上. 
# 虽然貌似 k8s 会在节点间直接传输镜像的样子(猜测) 
docker pull kubernetes/heapster_grafana:v2.6.0
docker pull kubernetes/heapster:canary
docker pull kubernetes/heapster_influxdb:v0.6
# create 之前还是提前 pull 镜像&修改拉取策略吧
kubectl create -f deploy/kube-config/influxdb/
``` 

实际看到文件夹内含6个 yaml,deploy 与 svc 各三份. 

- heapster - agent 与 k8s add-on 的作用
- influxdb - db
- grafana - ui

只是想达到如图效果很简单了,只要部署一个 heapster-svc 上来就够了,但是 metrics 数据也可以被记录到 influxdb 中配合 grafana 进行展现. 

```shell
kubectl create -f heaspter-deployment.yaml
kubectl create -f heaspter-service.yaml
```

这样即可达到上图的效果. 

那么使用完全版的话将以上三对儿生成完毕 

```
# 查看 nodeport
kubectl describe svc monitoring-grafana --namespace=kube-system
```

1. 访问 masterip:port 进入 grafana 管理界面,左侧 admin - admin 登陆 
2. 剩下的什么新建 influxdb 的步骤都不需要了,默认自带一个`http://monitoring-influxdb:8086`
3. 这个数据源是否靠谱还不确定,因为不知道你是否已经是 dns 生效过,那么 test connection 进行测试. 
4. 实际上一步换成你的 influsdb-svc 的 ip 也 ok. 

![](https://o4dyfn0ef.qnssl.com/image/2016-11-15-Screen%20Shot%202016-11-15%20at%2017.29.54.png?imageView2/2/h/300) 

> 不过我的 grafana 里还是没有数据显示,应该是 influxdb 那儿的问题,待解决,不过本部分算是配置完成,抓紧记下来备忘




