<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>日志监控平台搭建 关于flume Kafka Elk</title>
  <link rel="stylesheet" href="//fonts.useso.com/css?family=Source+Sans+Pro:300,300i,600">
  <link rel="stylesheet" href="/style.css">
  <!-- Begin Jekyll SEO tag v1.3.1 -->
<title>日志监控平台搭建 关于flume Kafka Elk - Coup de Grace</title>
<meta property="og:title" content="日志监控平台搭建 关于flume Kafka Elk" />
<meta name="description" content="最近需要搭建一套日志监控平台,参考了新浪与美团的一些东西.现在实录一下搭建与优化调整的过程" />
<meta property='og:description' content="最近需要搭建一套日志监控平台,参考了新浪与美团的一些东西.现在实录一下搭建与优化调整的过程" />
<link rel="canonical" href="http://www.slahser.com/2016/04/21/%E6%97%A5%E5%BF%97%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E6%90%AD%E5%BB%BA-%E5%85%B3%E4%BA%8EFlume-Kafka-ELK/" />
<meta property='og:url' content='http://www.slahser.com/2016/04/21/%E6%97%A5%E5%BF%97%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E6%90%AD%E5%BB%BA-%E5%85%B3%E4%BA%8EFlume-Kafka-ELK/' />
<meta property="og:site_name" content="Coup de Grace" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-04-21T00:00:00+08:00" />
<link rel="prev" href="http://www.slahser.com/2016/04/07/ps4%E7%9A%84remote-play%E5%B0%9D%E9%B2%9C%E4%B8%8E%E4%B8%80%E4%BA%9B%E5%85%B6%E4%BB%96%E5%B0%8F%E7%8E%A9%E6%84%8F%E5%84%BF/" title="Ps4的remote play尝鲜与一些其他小玩意儿" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@S1ahs3r" />
<meta name="twitter:title" content="日志监控平台搭建 关于flume Kafka Elk - Coup de Grace" />
<meta name="twitter:description" content="最近需要搭建一套日志监控平台,参考了新浪与美团的一些东西.现在实录一下搭建与优化调整的过程" />
<meta name="twitter:creator" content="@S1ahs3r" />
<script type="application/ld+json">
  {
    "@context" : "http://schema.org",


    "@type" : "BlogPosting",

    "headline": "日志监控平台搭建 关于flume Kafka Elk",

    "datePublished": "2016-04-21T00:00:00+08:00",

    "description": "最近需要搭建一套日志监控平台,参考了新浪与美团的一些东西.现在实录一下搭建与优化调整的过程",


    "url" : "http://www.slahser.com/2016/04/21/%E6%97%A5%E5%BF%97%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E6%90%AD%E5%BB%BA-%E5%85%B3%E4%BA%8EFlume-Kafka-ELK/"
  }
</script>
<!-- End Jekyll SEO tag -->
  <!--baidu analysis-->
  <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?800b2d15920eea57fe7abcb3c52892f6";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
  </script>
</head>
<body>
  <div class="container">
    <header class="masthead">
  <h1 class="masthead-title--small">
    <a href="/">Coup de Grace</a>
  </h1>
</header>
<div class="content post">
  <h1 class="post-title">日志监控平台搭建 关于flume Kafka Elk</h1>
  <div class="post-date">
    <time>21 Apr 2016</time>
  </div>
  <p>最近需要搭建一套日志监控平台,参考了新浪与美团的一些东西.现在实录一下搭建与优化调整的过程</p>

<blockquote>
  <p>目前把这几件放在一起的文档还不够多,其中相当一部分因为elk的升级配置也已经不能用了,更多的是单机版的配置,完全没有参考性.</p>
</blockquote>

<h2 id="section">架构图</h2>

<p><img src="http://7xqjx7.com1.z0.glb.clouddn.com/image/Screen%20Shot%202016-04-21%20at%2021.44.09.png?imageView2/2/h/200" alt="" /></p>

<h2 id="section-1">硬件配置</h2>

<ul>
  <li>本机 ubuntu 14.04</li>
  <li>线上 centos 6.5</li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: center">host</th>
      <th style="text-align: center">本地搭建</th>
      <th style="text-align: center">线上环境</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">c1</td>
      <td style="text-align: center">1core 1g</td>
      <td style="text-align: center">4core 8g</td>
    </tr>
    <tr>
      <td style="text-align: center">c2</td>
      <td style="text-align: center">1core 1g</td>
      <td style="text-align: center">4core 8g</td>
    </tr>
    <tr>
      <td style="text-align: center">c3</td>
      <td style="text-align: center">1core 1g</td>
      <td style="text-align: center">4core 8g</td>
    </tr>
    <tr>
      <td style="text-align: center">c4</td>
      <td style="text-align: center">2core 4g</td>
      <td style="text-align: center">8core 32g</td>
    </tr>
    <tr>
      <td style="text-align: center">c5</td>
      <td style="text-align: center">2core 4g</td>
      <td style="text-align: center">4core 32g</td>
    </tr>
  </tbody>
</table>

<h2 id="section-2">搭建</h2>

<h3 id="basic">basic</h3>

<p>新机器修改root密码<code class="highlighter-rouge">sudo passwd</code></p>

<p>创建用户</p>

<div class="highlighter-rouge"><pre class="highlight"><code>useradd cluster
passwd cluster
chmod +w /etc/sudoers
vim  /etc/sudoers
cluster <span class="nv">ALL</span><span class="o">=(</span>root<span class="o">)</span>NOPASSWD:ALL 
chmod -w /etc/sudoers
mkdir /home/cluster
mkdir /home/stack
chmod 777 /home/cluster
chmod 777 /home/stack
</code></pre>
</div>

<blockquote>
  <p>以上部分/home/stack用于存储所需所有tar.gz包
/home/cluster作为所有软件的安装目录
而后创建cluster目录下data目录,用于存放各组件配置,日志,数据
scp推荐工具ZOC7</p>
</blockquote>

<p>同步各个机器的hosts</p>

<div class="highlighter-rouge"><pre class="highlight"><code>127.0.0.1 localhost 
10.1.12.25 c1
10.1.12.23 c2
10.1.12.24 c3
10.1.12.27 c4
10.1.12.28 c5
</code></pre>
</div>

<p>分发各机器的rsa公钥</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ssh-keygen
cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys
chmod 700 ~/.ssh/authorized_keys 
chmod 600 -R ~/.ssh/
</code></pre>
</div>
<p>各机器profile设置</p>

<div class="highlighter-rouge"><pre class="highlight"><code>tar -zxvf 
sudo vim /etc/profile
<span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/home/cluster/jdk
<span class="nb">export </span><span class="nv">ZK_HOME</span><span class="o">=</span>/home/cluster/zookeeper
<span class="nb">export </span><span class="nv">KAFKA_HOME</span><span class="o">=</span>/home/cluster/kafka
<span class="nb">export </span><span class="nv">SCALA_HOME</span><span class="o">=</span>/home/cluster/scala
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$JAVA_HOME</span>/bin:<span class="nv">$ZK_HOME</span>/bin:<span class="nv">$KAFKA_HOME</span>/bin:<span class="nv">$SCALA_HOME</span>/bin   
替换系统默认java
sudo update-alternatives --install /usr/bin/java java /home/cluster/jdk/jre/bin/java 301 
sudo update-alternatives --config java 
java -version
</code></pre>
</div>

<p>前三台机器的cluster目录树</p>

<div class="highlighter-rouge"><pre class="highlight"><code>drwxr-xr-x  4 root    root    4096  4月 20 14:34 data/
drwxr-xr-x  8 uucp        143 4096  3月 21 13:13 jdk/
drwxr-xr-x  7 root    root    4096  4月 20 14:30 kafka/
drwxrwxr-x  6 cluster cluster 4096  3月  4 23:30 scala/
drwxr-xr-x 10 zy      zy      4096  4月 20 14:13 zookeeper/  
</code></pre>
</div>
<p>后两台机器的cluster目录树</p>

<div class="highlighter-rouge"><pre class="highlight"><code>drwxr-xr-x  4 zy      root    4096  4月 21 17:23 data/
drwxrwxrwx  7 zy      root    4096  4月 21 15:07 elasticsearch/
drwxr-xr-x  8 zy          143 4096  3月 21 13:13 jdk/
drwxr-xr-x 10 zy      staff   4096  3月 29 06:46 kibana/
drwxr-xr-x  5 zy      root    4096  4月 21 18:06 logstash/  
</code></pre>
</div>
<p>开发环境下关闭防火墙</p>

<div class="highlighter-rouge"><pre class="highlight"><code>chkconfig  iptables off 或者
ufw disable
</code></pre>
</div>
<p>非ubuntu机器关闭SELinux</p>

<div class="highlighter-rouge"><pre class="highlight"><code>修改 /etc/selinux/config 文件，将其中的 SELINUX=enforcing 改为 SELINUX=disabled
selinux默认ubuntu不安装,iptables默认也是全开放的.可以用getenforce和iptables -L命令查看下两个组件的状态
</code></pre>
</div>

<p>同步各机器时区</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</code></pre>
</div>

<h3 id="zookeeper">zookeeper配置</h3>

<p>修改conf目录下模板配置为zoo.cfg</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">tickTime</span>=<span class="m">2000</span>
<span class="n">initLimit</span>=<span class="m">10</span>
<span class="n">syncLimit</span>=<span class="m">5</span>
<span class="n">dataDir</span>=/<span class="n">home</span>/<span class="n">cluster</span>/<span class="n">data</span>/<span class="n">zookeeper</span>
<span class="n">clientPort</span>=<span class="m">2181</span>
<span class="n">server</span>.<span class="m">1</span>= <span class="n">c1</span>:<span class="m">2888</span>:<span class="m">3888</span>
<span class="n">server</span>.<span class="m">2</span>= <span class="n">c2</span>:<span class="m">2888</span>:<span class="m">3888</span>
<span class="n">server</span>.<span class="m">3</span>= <span class="n">c3</span>:<span class="m">2888</span>:<span class="m">3888</span>  
</code></pre>
</div>

<p>而后</p>

<p>在配置的dataDir目录下创建一个myid文件，里面写入一个0-255之间的一个随意数字，每个zk上这个文件的数字要是不一样的，这些数字应该是从1开始，依次写每个服务器。</p>

<blockquote>
  <p>文件中序号要与dn节点下的zk配置序号一直，如：server.1=c1:2888:3888，那么dn1节点下的myid配置文件应该写上1</p>
</blockquote>

<ul>
  <li>各节点启动:<code class="highlighter-rouge">bin/zkServer.sh start</code></li>
  <li>查看节点状态与leader与否<code class="highlighter-rouge">bin/zkServer.sh status</code></li>
  <li>查看java进程<code class="highlighter-rouge">jps</code></li>
</ul>

<h3 id="kafka">kafka配置</h3>

<p>配置目录下</p>

<p>zookeeper.properties</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">dataDir</span>=/<span class="n">home</span>/<span class="n">cluster</span>/<span class="n">data</span>/<span class="n">zookeeper</span>
<span class="n">clientPort</span>=<span class="m">2181</span>
<span class="n">maxClientCnxns</span>=<span class="m">0</span>  
</code></pre>
</div>

<p>server.properties</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">############### Server Basics ###############
</span><span class="n">broker</span>.<span class="n">id</span>=<span class="m">0</span>
<span class="c">############# Socket Server Settings #############
</span><span class="n">listeners</span>=<span class="n">PLAINTEXT</span>://:<span class="m">9092</span>
<span class="n">num</span>.<span class="n">network</span>.<span class="n">threads</span>=<span class="m">3</span>
<span class="n">num</span>.<span class="n">io</span>.<span class="n">threads</span>=<span class="m">8</span>
<span class="n">socket</span>.<span class="n">send</span>.<span class="n">buffer</span>.<span class="n">bytes</span>=<span class="m">102400</span>
<span class="n">socket</span>.<span class="n">receive</span>.<span class="n">buffer</span>.<span class="n">bytes</span>=<span class="m">102400</span>
<span class="n">socket</span>.<span class="n">request</span>.<span class="n">max</span>.<span class="n">bytes</span>=<span class="m">104857600</span>
<span class="c">##############Log Basics ##############
</span><span class="n">log</span>.<span class="n">dirs</span>=/<span class="n">home</span>/<span class="n">cluster</span>/<span class="n">data</span>/<span class="n">kafka</span>/<span class="n">log</span>
<span class="n">num</span>.<span class="n">partitions</span>=<span class="m">1</span>
<span class="n">num</span>.<span class="n">recovery</span>.<span class="n">threads</span>.<span class="n">per</span>.<span class="n">data</span>.<span class="n">dir</span>=<span class="m">1</span>
<span class="c">############ Log Retention Policy ###############
</span><span class="n">log</span>.<span class="n">retention</span>.<span class="n">hours</span>=<span class="m">168</span>
<span class="n">log</span>.<span class="n">segment</span>.<span class="n">bytes</span>=<span class="m">1073741824</span>
<span class="n">log</span>.<span class="n">retention</span>.<span class="n">check</span>.<span class="n">interval</span>.<span class="n">ms</span>=<span class="m">300000</span>
<span class="c">############## Zookeeper ###############
</span><span class="n">zookeeper</span>.<span class="n">connect</span>=<span class="n">localhost</span>:<span class="m">2181</span>
<span class="n">zookeeper</span>.<span class="n">connection</span>.<span class="n">timeout</span>.<span class="n">ms</span>=<span class="m">6000</span>  
</code></pre>
</div>

<p>producer.properties</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">############### Producer Basics ##############
</span><span class="n">metadata</span>.<span class="n">broker</span>.<span class="n">list</span>=<span class="n">c1</span>:<span class="m">9092</span>,<span class="n">c2</span>:<span class="m">9092</span>,<span class="n">c3</span>:<span class="m">9092</span>
<span class="n">producer</span>.<span class="n">type</span>=<span class="n">sync</span>
<span class="n">compression</span>.<span class="n">codec</span>=<span class="n">none</span>
<span class="n">serializer</span>.<span class="n">class</span>=<span class="n">kafka</span>.<span class="n">serializer</span>.<span class="n">DefaultEncoder</span>    
</code></pre>
</div>

<p>consumer.properties</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">zookeeper</span>.<span class="n">connect</span>=<span class="n">c1</span>:<span class="m">2181</span>,<span class="n">c2</span>:<span class="m">2181</span>,<span class="n">c3</span>:<span class="m">2181</span>
<span class="n">zookeeper</span>.<span class="n">connection</span>.<span class="n">timeout</span>.<span class="n">ms</span>=<span class="m">6000</span>
<span class="n">group</span>.<span class="n">id</span>=<span class="n">cluster</span>-<span class="n">consumer</span>-<span class="n">group</span> 
</code></pre>
</div>

<ul>
  <li>启动<code class="highlighter-rouge">bin/kafka-server-start.sh config/server.properties &amp; </code></li>
  <li>依然jps<code class="highlighter-rouge">jps</code></li>
</ul>

<p>测试</p>

<blockquote>
  <p>本部分的分片partitions有待调整,分布式的logstash需要分片的消息,否则会出现消息顺序错误</p>
</blockquote>

<p>leader上执行</p>

<div class="highlighter-rouge"><pre class="highlight"><code>bin/kafka-topics.sh --zookeeper c1:2181,c2:2181,c3:2181 --topic tt_topic --replication-factor 3 --partitions 1 --create
bin/kafka-topics.sh --zookeeper c1:2181,c2:2181,c3:2181 --topic tt_topic --describe
</code></pre>
</div>

<p>leader消息发送</p>

<div class="highlighter-rouge"><pre class="highlight"><code>bin/kafka-console-producer.sh --broker-list c1:9092,c2:9092,c3:9092 --topic tt_topic
</code></pre>
</div>

<p>从者消息消费</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">bin</span>/<span class="n">kafka</span>-<span class="n">console</span>-<span class="n">consumer</span>.<span class="n">sh</span> --<span class="n">zookeeper</span> <span class="n">c1</span>:<span class="m">2181</span>,<span class="n">c2</span>:<span class="m">2181</span>,<span class="n">c3</span>:<span class="m">2181</span> --<span class="n">from</span>-<span class="n">beginning</span> --<span class="n">topic</span> <span class="n">tt_topic</span>
</code></pre>
</div>

<h3 id="elasticsearch">elasticsearch配置</h3>

<p>修改es文件夹所属用户组 <code class="highlighter-rouge">chown -R cluster /home/cluster/elaticsearch</code></p>

<p>es配置</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">cluster</span>.<span class="n">name</span>: <span class="n">elasticsearch</span>
<span class="n">node</span>.<span class="n">name</span>: <span class="n">c4</span>
<span class="n">path</span>.<span class="n">data</span>: /<span class="n">home</span>/<span class="n">cluster</span>/<span class="n">data</span>/<span class="n">elasticsearch</span>/<span class="n">data</span>
<span class="n">path</span>.<span class="n">logs</span>: /<span class="n">home</span>/<span class="n">cluster</span>/<span class="n">data</span>/<span class="n">elasticsearch</span>/<span class="n">log</span>
<span class="n">bootstrap</span>.<span class="n">mlockall</span>: <span class="n">true</span>
<span class="n">network</span>.<span class="n">host</span>: <span class="m">10</span>.<span class="m">1</span>.<span class="m">12</span>.<span class="m">27</span>
<span class="n">http</span>.<span class="n">port</span>: <span class="m">9200</span>
<span class="n">discovery</span>.<span class="n">zen</span>.<span class="n">ping</span>.<span class="n">unicast</span>.<span class="n">hosts</span>: [<span class="s2">"c4"</span>, <span class="s2">"c5"</span>]
<span class="n">discovery</span>.<span class="n">zen</span>.<span class="n">minimum_master_nodes</span>: <span class="m">2</span> 
</code></pre>
</div>

<p>安装插件</p>

<div class="highlighter-rouge"><pre class="highlight"><code> bin/plugin install mobz/elasticsearch-head
 bin/plugin install lmenezes/elasticsearch-kopf
 bin/plugin install lukas-vlcek/bigdesk
</code></pre>
</div>

<ul>
  <li>运行<code class="highlighter-rouge">bin/elasticsearch -d</code></li>
  <li>状态查看<code class="highlighter-rouge">http://10.1.12.27:9200/_plugin/head/</code></li>
</ul>

<h3 id="kibana">kibana配置</h3>

<p>基本设置需要修改的部分</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">server</span>.<span class="n">port</span>: <span class="m">5601</span>
<span class="n">server</span>.<span class="n">host</span>: <span class="s2">"c4"</span>
<span class="n">elasticsearch</span>.<span class="n">url</span>: <span class="s2">"http://c4:9200"</span>  
</code></pre>
</div>
<p>访问<code class="highlighter-rouge">http://10.1.12.27:5601</code></p>

<h3 id="logstash">logstash配置</h3>

<p>修改ruby源,修改Gemfile文件<code class="highlighter-rouge">https://ruby.taobao.org</code></p>

<p>安装插件</p>

<div class="highlighter-rouge"><pre class="highlight"><code>bin/logstash-plugin install logstash-input-kafka
bin/logstash-plugin install logstash-output-elasticsearch
</code></pre>
</div>
<p>新建kafka-logstash-es.conf</p>

<p>置于cluster/data/logstash/conf目录下</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">input</span> {
    <span class="n">kafka</span> {
        <span class="n">zk_connect</span> =&gt; <span class="s2">"c1:2181,c2:2181,c3:2181"</span>
        <span class="n">group_id</span> =&gt; <span class="s2">"cluster-consumer-group"</span>
        <span class="n">topic_id</span> =&gt; <span class="s2">"tt_topic"</span>
        <span class="n">reset_beginning</span> =&gt; <span class="n">false</span> 
        <span class="n">consumer_threads</span> =&gt; <span class="m">5</span>  
        <span class="n">decorate_events</span> =&gt; <span class="n">true</span> 
        <span class="n">codec</span> =&gt; <span class="s2">"json"</span>
        }
    }
<span class="n">output</span> {
    <span class="n">elasticsearch</span> {
        <span class="n">hosts</span> =&gt; [<span class="s2">"c4:9200"</span>,<span class="s2">"c5:9200"</span>]
        <span class="n">index</span> =&gt; <span class="s2">"logstash-%{type}-%{+YYYY.MM.dd}"</span>
        <span class="n">workers</span> =&gt; <span class="m">5</span>
        <span class="n">codec</span> =&gt; <span class="s2">"json"</span>
		  }
	 }
</code></pre>
</div>

<p>测试配置文件</p>

<div class="highlighter-rouge"><pre class="highlight"><code>bin/logstash -f /home/cluster/data/logstash/conf/kafka-logstash-es.conf --configtest
</code></pre>
</div>

<p>运行</p>

<div class="highlighter-rouge"><pre class="highlight"><code>nohup bin/logstash -f /home/cluster/data/logstash/conf/kafka-logstash-es.conf  &amp;
</code></pre>
</div>
<blockquote>
  <p>想要使用多个 logstash 端协同消费同一个 topic 的话，那么需要把两个或是多个 logstash 消费端配置成相同的 group_id 和 topic_id</p>

  <p>但是前提是要把相应的 topic 分多个 partitions (区)，多个消费者消费是无法保证消息的消费顺序性的</p>

  <p>查看后台任务 jobs</p>

  <p>杀掉后台任务 kill %number</p>
</blockquote>

</div>
  </div>
</body>
</html>
